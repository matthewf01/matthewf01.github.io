<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anleigh's Social Studies Review</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient-start: #ff7e5f;
            --bg-gradient-mid1: #feb47b;
            --bg-gradient-mid2: #86a8e7;
            --bg-gradient-end: #5ff3a0;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --border-color: rgba(255, 255, 255, 0.2);
            --correct-color: #28a745;
            --incorrect-color: #6c757d;
            --highlight-color: yellow;
            --text-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        /* General Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 2rem 1rem;
            background: radial-gradient(circle, var(--bg-gradient-start), var(--bg-gradient-mid1), var(--bg-gradient-mid2), var(--bg-gradient-end));
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Glassmorphism Container */
        .game-container {
            width: 100%;
            max-width: 900px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 2rem;
            box-sizing: border-box;
            position: relative;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin: 0;
            text-shadow: var(--text-shadow);
        }
        .header p {
            font-size: 1.2rem;
            margin-top: 0.5rem;
            opacity: 0.9;
        }

        /* Hide Screens by Default */
        #main-menu-screen, #quiz-screen {
            display: none;
        }

        /* Main Menu Styling */
        .unit-list-header, .unit-row {
            display: grid;
            grid-template-columns: 4fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .unit-list-header {
            font-weight: bold;
            font-size: 1.1rem;
            padding-bottom: 1rem;
            text-align: center;
        }
        .unit-title {
            font-weight: 500;
        }
        .unit-score {
            text-align: center;
        }
        .unit-actions {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Icon Buttons */
        .icon-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s ease;
            position: relative;
        }
        .icon-button:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        .icon-button svg {
            width: 20px;
            height: 20px;
            fill: var(--text-color);
        }
        .tooltip {
            visibility: hidden;
            width: max-content;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .icon-button:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Rainbow Animated Button */
        .animated-gradient-button {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background-color: #8a2be2;
            transition: transform 0.2s;
            margin-top: 2rem;
            text-shadow: var(--text-shadow);
        }
        .animated-gradient-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 300%;
            height: 100%;
            background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet, red);
            transition: left 0.5s ease-in-out;
            z-index: 0;
        }
        .animated-gradient-button:hover::before {
            left: 0;
        }
        .animated-gradient-button span {
            position: relative;
            z-index: 1;
        }

        /* Dark Animated Button */
        .dark-animated-button {
             background: linear-gradient(90deg, #4b0082, #8a2be2, #0000ff);
             background-size: 200% 200%;
             animation: gradient-animation 5s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Quiz Screen */
        .quiz-header {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 900px;
            z-index: 10;
        }
        .quiz-title { font-size: 1.5rem; font-weight: bold; }
        .back-button {
            background: rgba(0,0,0,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
        }
        .quiz-stats { display: flex; gap: 1.5rem; font-size: 1.1rem; }

        #question-container {
            margin-top: 80px; /* Space for fixed header */
        }
        .question-text-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.8rem;
            margin-bottom: 2rem;
            text-shadow: var(--text-shadow);
        }
        .aks-reference {
            display: block;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }
        #answer-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        .answer-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            font-size: 1.1rem;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
        }
        .answer-btn:not([disabled]):hover {
            background: rgba(0,0,0,0.4);
            transform: translateY(-2px);
        }
        .answer-btn[disabled] {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .answer-btn.correct {
            background: var(--correct-color);
            border-color: #1a6e2f;
            color: black;
            font-weight: bold;
            animation: flash-green 0.5s ease;
        }
        .answer-btn.incorrect {
            background: var(--incorrect-color);
            border-color: #495057;
            opacity: 0.6;
        }
        @keyframes flash-green {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Study Guide */
        #study-guide-container {
            margin-top: 2rem;
            max-height: 0;
            overflow-y: auto;
            transition: max-height 0.7s ease-in-out;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 0 1.5rem;
        }
        #study-guide-container.visible {
            max-height: 400px;
            padding: 1.5rem;
        }
        .study-guide-content {
            color: #f0f0f0;
        }
        .study-guide-content .highlight {
            background-color: var(--highlight-color);
            color: black;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Quiz Controls */
        #quiz-controls { margin-top: 2rem; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            margin: auto;
            padding: 2.5rem;
            width: 90%;
            max-width: 800px;
            position: relative;
        }
        .modal-close {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus {
            color: white;
        }

        /* Footer and Sound Toggle */
        .footer {
            margin-top: 2rem;
            text-align: center;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        #sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            border-radius: 50%;
            pointer-events: none;
            animation: fall 3s linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
                opacity: 0;
            }
        }

        /* Brain Break Styles */
        #brain-break-modal .modal-content { text-align: center; }
        #brain-break-timer { font-size: 4rem; margin: 1rem 0; }
        #brain-break-canvas {
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 10px;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            body { padding: 1rem 0.5rem; }
            .game-container { padding: 1.5rem; }
            .header h1 { font-size: 2rem; }
            .header p { font-size: 1rem; }
            .quiz-header { padding: 0.75rem 1rem; width: 95%; }
            .quiz-title { font-size: 1.1rem; }
            .quiz-stats { gap: 1rem; font-size: 1rem; }
            #question-container { margin-top: 70px; }
            .question-text-container { font-size: 1.3rem; }
            #answer-buttons { grid-template-columns: 1fr; }
            .unit-list-header, .unit-row {
                grid-template-columns: 3fr 1.5fr 1.5fr;
                gap: 0.5rem;
                font-size: 0.9rem;
            }
            .unit-list-header { text-align: left; }
            .unit-list-header > span:not(:first-child) { text-align: center; }
        }

    </style>
</head>
<body>

    <div class="quiz-header" id="quiz-header-bar" style="display: none;">
        <button class="back-button" id="back-to-menu-btn">Back to Main Menu</button>
        <div class="quiz-title" id="quiz-header-title">Unit Title</div>
        <div class="quiz-stats">
            <span id="question-counter">Q: 1/20</span>
            <span id="score-counter">Score: 0</span>
        </div>
    </div>

    <div class="game-container">
        <header class="header">
            <h1>Anleigh's Social Studies Review</h1>
            <p>Choose a unit below to play a game!</p>
        </header>

        <!-- Main Menu Screen -->
        <div id="main-menu-screen">
            <div class="unit-list-header">
                <span>Unit</span>
                <span style="text-align: center;">Study Guide</span>
                <span style="text-align: center;">Play Game</span>
            </div>
            <div id="unit-list"></div>
            <button class="animated-gradient-button" id="final-exam-btn"><span>Final Exam</span></button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen">
            <div id="question-container">
                <div class="question-text-container">
                    <button class="icon-button tts-button" id="tts-question">
                         <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                    </button>
                    <div>
                        <span id="question-text"></span>
                        <span id="aks-reference" class="aks-reference"></span>
                    </div>
                </div>
                <div id="answer-buttons"></div>
            </div>

            <div id="quiz-controls">
                <button class="animated-gradient-button dark-animated-button" id="toggle-study-guide-btn"><span>Toggle Study Guide</span></button>
                <button class="animated-gradient-button" id="next-question-btn" style="display: none;"><span>Next Question</span></button>
            </div>
             <div id="study-guide-container">
                <div class="study-guide-content" id="study-guide-content-quiz"></div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <span id="build-number"></span>
    </div>

    <button class="icon-button" id="sound-toggle">
        <!-- Speaker Icon -->
    </button>

    <!-- Study Guide Modal -->
    <div id="study-guide-modal" class="modal">
        <div class="modal-content game-container">
            <span class="modal-close">&times;</span>
            <h2 id="study-guide-modal-title"></h2>
            <div id="study-guide-modal-content"></div>
        </div>
    </div>

    <!-- Brain Break Modal -->
    <div id="brain-break-modal" class="modal">
        <div class="modal-content game-container">
            <h2>Brain Break!</h2>
            <p>Time to rest for a moment.</p>
            <canvas id="brain-break-canvas"></canvas>
            <div id="brain-break-timer">30</div>
            <button id="continue-quiz-btn" class="animated-gradient-button dark-animated-button"><span>Continue Quiz</span></button>
        </div>
    </div>

    <script>
    // --- DATA ---
    const studyUnits = [
        {
            title: "Unit 1: Georgia's Beginnings",
            studyGuideHTML: `
                <h3>AKS 30: Geographic Understanding</h3>
                <p><strong data-aks="30a">AKS 30.a: Georgia's Location</strong> - Georgia is located in the Northern and Western hemispheres. It is on the continent of North America, in the country of the United States. Georgia is in the Southeastern region of the USA.</p>
                <p><strong data-aks="30b">AKS 30.b: Georgia's Geographic Regions</strong> - Georgia has five distinct geographic regions: the Appalachian Plateau (smallest region, known for coal), the Ridge and Valley (known for carpets and textiles), the Blue Ridge (highest elevation, most rainfall, start of Appalachian Trail), the Piedmont (most populated, red clay, granite), and the Coastal Plain (largest region, agriculture, peanuts, peaches).</p>
                <p><strong data-aks="30c">AKS 30.c: Key Physical Features</strong> - The Fall Line is a natural boundary separating the Piedmont and Coastal Plain regions, where waterfalls provided early power sources. The Okefenokee Swamp is the largest freshwater swamp in North America. The Appalachian Mountains are in the northern three regions. The Chattahoochee River forms Georgia's western border with Alabama. The Savannah River forms the eastern border with South Carolina. Barrier islands protect the mainland coast.</p>
            `,
            questions: [
                {
                    question: "In which two hemispheres is Georgia located?",
                    options: ["Northern and Western", "Southern and Eastern", "Northern and Eastern", "Southern and Western"],
                    correctAnswer: "Northern and Western",
                    aks: "30a",
                    aksName: "Georgia's Location"
                },
                {
                    question: "Which geographic region of Georgia is the most populated and known for its red clay?",
                    options: ["Piedmont", "Blue Ridge", "Coastal Plain", "Appalachian Plateau"],
                    correctAnswer: "Piedmont",
                    aks: "30b",
                    aksName: "Georgia's Geographic Regions"
                },
                {
                    question: "What is the largest freshwater swamp in North America, located in Georgia?",
                    options: ["Okefenokee Swamp", "Everglades", "Great Dismal Swamp", "Atchafalaya Basin"],
                    correctAnswer: "Okefenokee Swamp",
                    aks: "30c",
                    aksName: "Key Physical Features"
                },
                {
                    question: "The Savannah River forms Georgia's border with which state?",
                    options: ["South Carolina", "Alabama", "Florida", "Tennessee"],
                    correctAnswer: "South Carolina",
                    aks: "30c",
                    aksName: "Key Physical Features"
                },
                {
                    question: "What is the smallest geographic region in Georgia?",
                    options: ["Appalachian Plateau", "Piedmont", "Blue Ridge", "Coastal Plain"],
                    correctAnswer: "Appalachian Plateau",
                    aks: "30b",
                    aksName: "Georgia's Geographic Regions"
                },
                 {
                    question: "Which continent contains the state of Georgia?",
                    options: ["North America", "South America", "Europe", "Asia"],
                    correctAnswer: "North America",
                    aks: "30a",
                    aksName: "Georgia's Location"
                },
                {
                    question: "The highest elevation and most rainfall in Georgia can be found in which region?",
                    options: ["Blue Ridge", "Piedmont", "Ridge and Valley", "Coastal Plain"],
                    correctAnswer: "Blue Ridge",
                    aks: "30b",
                    aksName: "Georgia's Geographic Regions"
                },
                {
                    question: "What natural boundary separates the Piedmont and Coastal Plain regions?",
                    options: ["The Fall Line", "The Chattahoochee River", "The Appalachian Trail", "The Mason-Dixon Line"],
                    correctAnswer: "The Fall Line",
                    aks: "30c",
                    aksName: "Key Physical Features"
                }
            ]
        },
        {
            title: "Unit 2: Exploration & Colonization",
            studyGuideHTML: `
                <h3>AKS 31: European Exploration and Colonization</h3>
                <p><strong data-aks="31a">AKS 31.a: Reasons for Exploration</strong> - The primary reasons for European exploration of the New World were summarized as "God, Gold, and Glory." Spain was primarily interested in finding gold and converting natives to Catholicism. Great Britain sought to establish colonies for raw materials (mercantilism) and religious freedom. France was focused on the fur trade.</p>
                <p><strong data-aks="31b">AKS 31.b: James Oglethorpe & the Founding of Georgia</strong> - James Oglethorpe was the primary founder of the Georgia colony. The Charter of 1732, which officially created Georgia, outlined three main reasons for its founding: philanthropy (to help debtors), defense (a buffer colony against Spanish Florida), and economics (to produce goods England couldn't).</p>
                <p><strong data-aks="31c">AKS 31.c: Trustee Georgia</strong> - During the Trustee Period, Georgia had strict rules, including prohibitions on slavery, rum, and Catholics. Key figures included Tomochichi (Yamacraw chief who allied with Oglethorpe) and Mary Musgrove (who served as the interpreter between them). The Salzburgers and Highland Scots were notable immigrant groups who settled in Georgia.</p>
            `,
            questions: [
                {
                    question: "Which of the following was NOT one of the three main reasons for the founding of Georgia according to the Charter of 1732?",
                    options: ["Religious Freedom", "Philanthropy", "Defense", "Economics"],
                    correctAnswer: "Religious Freedom",
                    aks: "31b",
                    aksName: "James Oglethorpe & the Founding of Georgia"
                },
                {
                    question: "Who served as the crucial interpreter between James Oglethorpe and Tomochichi?",
                    options: ["Mary Musgrove", "Pocahontas", "Sacagawea", "Nancy Hart"],
                    correctAnswer: "Mary Musgrove",
                    aks: "31c",
                    aksName: "Trustee Georgia"
                },
                {
                    question: "The phrase 'God, Gold, and Glory' best describes the motivations of which exploring country?",
                    options: ["Spain", "France", "Great Britain", "Portugal"],
                    correctAnswer: "Spain",
                    aks: "31a",
                    aksName: "Reasons for Exploration"
                },
                 {
                    question: "During the Trustee Period, which of the following was banned in Georgia?",
                    options: ["Slavery", "Tobacco", "Cotton", "Indigo"],
                    correctAnswer: "Slavery",
                    aks: "31c",
                    aksName: "Trustee Georgia"
                },
                {
                    question: "What was the primary economic interest of the French in North America?",
                    options: ["Fur trading", "Gold mining", "Cotton farming", "Growing sugar"],
                    correctAnswer: "Fur trading",
                    aks: "31a",
                    aksName: "Reasons for Exploration"
                },
                {
                    question: "Georgia was established as a 'buffer' colony to protect the other English colonies from whom?",
                    options: ["The Spanish in Florida", "The French in Louisiana", "Native American tribes", "Pirates in the Caribbean"],
                    correctAnswer: "The Spanish in Florida",
                    aks: "31b",
                    aksName: "James Oglethorpe & the Founding of Georgia"
                }
            ]
        }
    ];

    // --- DOM ELEMENTS ---
    const mainMenuScreen = document.getElementById('main-menu-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const unitListContainer = document.getElementById('unit-list');
    const questionTextEl = document.getElementById('question-text');
    const aksReferenceEl = document.getElementById('aks-reference');
    const answerButtonsEl = document.getElementById('answer-buttons');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const quizHeaderBar = document.getElementById('quiz-header-bar');
    const quizHeaderTitle = document.getElementById('quiz-header-title');
    const questionCounterEl = document.getElementById('question-counter');
    const scoreCounterEl = document.getElementById('score-counter');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const finalExamBtn = document.getElementById('final-exam-btn');
    const soundToggle = document.getElementById('sound-toggle');
    const buildNumberEl = document.getElementById('build-number');

    // Study Guide Elements
    const studyGuideModal = document.getElementById('study-guide-modal');
    const studyGuideModalTitle = document.getElementById('study-guide-modal-title');
    const studyGuideModalContent = document.getElementById('study-guide-modal-content');
    const toggleStudyGuideBtn = document.getElementById('toggle-study-guide-btn');
    const studyGuideContainer = document.getElementById('study-guide-container');
    const studyGuideContentQuiz = document.getElementById('study-guide-content-quiz');
    
    // Brain Break Elements
    const brainBreakModal = document.getElementById('brain-break-modal');
    const brainBreakCanvas = document.getElementById('brain-break-canvas');
    const brainBreakTimerEl = document.getElementById('brain-break-timer');
    const continueQuizBtn = document.getElementById('continue-quiz-btn');

    // --- GAME STATE ---
    let currentScreen = 'menu';
    let currentUnitIndex = -1;
    let questionQueue = [];
    let originalQuestionCount = 0;
    let currentQuestionIndex = 0;
    let score = 0;
    let soundEnabled = true;
    let questionsAnsweredInSession = 0;
    let brainBreakCounter = 0;
    let brainBreakInterval;
    let currentBrainBreakAnimation;

    // --- AUDIO CONTEXT for Sound Effects ---
    let audioCtx;
    const correctSound = () => playSound(523.25, 0.1, 'sine'); // C5
    const incorrectSound = () => playSound(261.63, 0.2, 'square'); // C4

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', init);

    function init() {
        setBuildNumber();
        loadPreferences();
        showMainMenu();
        setupEventListeners();
        updateSoundToggleIcon();
    }
    
    function setBuildNumber() {
        const d = new Date();
        const yy = d.getFullYear().toString().slice(-2);
        const mm = (d.getMonth() + 1).toString().padStart(2, '0');
        const dd = d.getDate().toString().padStart(2, '0');
        buildNumberEl.textContent = `MF Build: ${yy}${mm}${dd}.1`;
    }

    function showScreen(screenId) {
        mainMenuScreen.style.display = 'none';
        quizScreen.style.display = 'none';
        quizHeaderBar.style.display = 'none';
        document.getElementById(screenId).style.display = 'block';
        if (screenId === 'quiz-screen') {
            quizHeaderBar.style.display = 'flex';
        }
    }

    function setupEventListeners() {
        finalExamBtn.addEventListener('click', () => startQuiz('final_exam'));
        backToMenuBtn.addEventListener('click', showMainMenu);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        soundToggle.addEventListener('click', toggleSound);
        toggleStudyGuideBtn.addEventListener('click', toggleStudyGuideVisibility);
        studyGuideModal.querySelector('.modal-close').addEventListener('click', () => studyGuideModal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == studyGuideModal) studyGuideModal.style.display = 'none';
            if (event.target == brainBreakModal) return; // Prevent closing by clicking outside
        });
        continueQuizBtn.addEventListener('click', endBrainBreak);
    }
    
    // --- MAIN MENU ---
    function showMainMenu() {
        currentScreen = 'menu';
        showScreen('main-menu-screen');
        renderUnitList();
    }

    function renderUnitList() {
        unitListContainer.innerHTML = '';
        studyUnits.forEach((unit, index) => {
            const highScore = getCookie(`highscore_${index}`) || '0%';
            const unitRow = document.createElement('div');
            unitRow.className = 'unit-row';
            unitRow.innerHTML = `
                <div class="unit-title">${unit.title}</div>
                <div class="unit-score">High Score: ${highScore}</div>
                <div class="unit-actions">
                    <button class="icon-button" data-unit-index="${index}" data-action="guide" title="View Study Guide for ${unit.title}">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg>
                        <span class="tooltip">View Study Guide for ${unit.title}</span>
                    </button>
                    <button class="icon-button" data-unit-index="${index}" data-action="play" title="Start Quiz for ${unit.title}">
                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                        <span class="tooltip">Start Quiz for ${unit.title}</span>
                    </button>
                </div>
            `;
            unitListContainer.appendChild(unitRow);
        });

        // Add event listeners for the newly created buttons
        unitListContainer.querySelectorAll('.icon-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const button = e.currentTarget;
                const index = button.dataset.unitIndex;
                const action = button.dataset.action;
                if (action === 'play') {
                    startQuiz(parseInt(index));
                } else if (action === 'guide') {
                    showStudyGuideModal(parseInt(index));
                }
            });
        });
    }

    // --- QUIZ LOGIC ---
    function startQuiz(unitIndexOrIdentifier) {
        currentScreen = 'quiz';
        let questions;
        let unitTitle;

        if (unitIndexOrIdentifier === 'final_exam') {
            currentUnitIndex = 'final_exam';
            questions = studyUnits.flatMap(unit => unit.questions);
            unitTitle = 'Final Exam';
            studyGuideContentQuiz.innerHTML = studyUnits.map(u => u.studyGuideHTML).join('<hr>');
        } else {
            currentUnitIndex = unitIndexOrIdentifier;
            const unit = studyUnits[currentUnitIndex];
            questions = [...unit.questions];
            unitTitle = unit.title;
            studyGuideContentQuiz.innerHTML = unit.studyGuideHTML;
        }

        questionQueue = shuffleArray(questions.map((q, i) => ({...q, originalIndex: i, isRepeat: false})));
        originalQuestionCount = questionQueue.length;
        currentQuestionIndex = 0;
        score = 0;
        questionsAnsweredInSession = 0;
        
        quizHeaderTitle.textContent = unitTitle;
        showScreen('quiz-screen');
        displayQuestion();
        updateCounters();
    }

    function displayQuestion() {
        if (currentQuestionIndex >= questionQueue.length) {
            endQuiz();
            return;
        }

        const questionData = questionQueue[currentQuestionIndex];
        const questionNumber = currentQuestionIndex + 1;
        const repeatText = questionData.isRepeat ? " (Repeat)" : "";
        
        questionTextEl.textContent = questionData.question;
        aksReferenceEl.textContent = `AKS ${questionData.aks}: ${questionData.aksName}`;
        questionCounterEl.textContent = `Q: ${questionNumber}/${originalQuestionCount}${repeatText}`;

        answerButtonsEl.innerHTML = '';
        const shuffledOptions = shuffleArray(questionData.options);
        shuffledOptions.forEach(option => {
            const button = document.createElement('button');
            button.className = 'answer-btn';
            button.innerHTML = `
                <span class="icon-button tts-button" style="width:30px; height:30px; flex-shrink: 0;">
                    <svg viewBox="0 0 24 24" style="width:16px; height:16px;"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                </span>
                <span>${option}</span>
            `;
            button.addEventListener('click', () => selectAnswer(option, button));
            button.querySelector('.tts-button').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent answer selection
                speak(option);
            });
            answerButtonsEl.appendChild(button);
        });
        
        document.getElementById('tts-question').onclick = () => speak(questionData.question);

        nextQuestionBtn.style.display = 'none';
        updateCounters();
    }

    function selectAnswer(selectedOption, buttonElement) {
        const questionData = questionQueue[currentQuestionIndex];
        const isCorrect = selectedOption === questionData.correctAnswer;
        
        // Disable all buttons
        const allButtons = answerButtonsEl.querySelectorAll('.answer-btn');
        allButtons.forEach(btn => btn.disabled = true);

        if (isCorrect) {
            buttonElement.classList.add('correct');
            if (!questionData.isRepeat) {
                score++;
            }
            correctSound();
            triggerConfetti();
            setTimeout(nextQuestion, 3000);
        } else {
            score = Math.max(0, score - 1);
            buttonElement.classList.add('incorrect');
            allButtons.forEach(btn => {
                if (btn.textContent.trim().includes(questionData.correctAnswer)) {
                    btn.classList.add('correct');
                } else {
                    btn.classList.add('incorrect');
                }
            });
            
            const repeatQuestion = {...questionData, isRepeat: true};
            questionQueue.push(repeatQuestion);
            incorrectSound();
            nextQuestionBtn.style.display = 'block';
        }

        updateCounters();
        expandAndHighlightStudyGuide(questionData.aks);
    }
    
    function nextQuestion() {
        currentQuestionIndex++;
        questionsAnsweredInSession++;

        if (questionsAnsweredInSession > 0 && questionsAnsweredInSession % 6 === 0 && currentQuestionIndex < questionQueue.length) {
            startBrainBreak();
        } else {
            displayQuestion();
        }
    }

    function endQuiz() {
        const finalScorePercent = (score / originalQuestionCount * 100).toFixed(0);
        const oldHighScore = parseInt(getCookie(`highscore_${currentUnitIndex}`) || '0');

        let message = `<h2>Quiz Complete!</h2><p>Your final score is: <strong>${finalScorePercent}%</strong></p>`;
        if (parseInt(finalScorePercent) > oldHighScore) {
            message += "<p>Congratulations! You set a new high score!</p>";
            setCookie(`highscore_${currentUnitIndex}`, `${finalScorePercent}%`, 365);
        }

        quizScreen.innerHTML = `<div style="text-align: center;">${message}<button id="return-home-btn" class="animated-gradient-button"><span>Return to Main Menu</span></button></div>`;
        document.getElementById('return-home-btn').addEventListener('click', () => {
             location.reload(); // Simple way to reset state
        });
    }

    function updateCounters() {
        scoreCounterEl.textContent = `Score: ${score}`;
    }

    // --- STUDY GUIDE ---
    function showStudyGuideModal(index) {
        const unit = studyUnits[index];
        studyGuideModalTitle.textContent = unit.title;
        studyGuideModalContent.innerHTML = unit.studyGuideHTML;
        studyGuideModal.style.display = 'flex';
    }

    function toggleStudyGuideVisibility() {
        studyGuideContainer.classList.toggle('visible');
    }

    function expandAndHighlightStudyGuide(aksCode) {
        // Clear previous highlights
        studyGuideContentQuiz.querySelectorAll('.highlight').forEach(el => {
            el.outerHTML = el.innerHTML; 
        });

        const targetEl = studyGuideContentQuiz.querySelector(`[data-aks="${aksCode}"]`);
        if (targetEl) {
            targetEl.classList.add('highlight');
            studyGuideContainer.classList.add('visible');
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    // --- BRAIN BREAK ---
    function startBrainBreak() {
        brainBreakModal.style.display = 'flex';
        let timeLeft = 30;
        brainBreakTimerEl.textContent = timeLeft;

        brainBreakInterval = setInterval(() => {
            timeLeft--;
            brainBreakTimerEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                endBrainBreak();
            }
        }, 1000);
        
        // Cycle through animations
        brainBreakCounter = (brainBreakCounter + 1) % 3;
        if(currentBrainBreakAnimation) cancelAnimationFrame(currentBrainBreakAnimation);
        
        if (brainBreakCounter === 1) {
            initBouncingBalls();
        } else if (brainBreakCounter === 2) {
            init3DStarfield();
        } else {
            initParticleTrail();
        }
    }
    
    function endBrainBreak() {
        clearInterval(brainBreakInterval);
        brainBreakModal.style.display = 'none';
        if(currentBrainBreakAnimation) cancelAnimationFrame(currentBrainBreakAnimation);
        displayQuestion();
    }
    
    // --- UTILITIES & HELPERS ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function loadPreferences() {
        const soundPref = getCookie('soundEnabled');
        if (soundPref !== null) {
            soundEnabled = soundPref === 'true';
        }
    }

    // --- AUDIO ---
    function playSound(frequency, duration, type) {
        if (!soundEnabled) return;
        if (!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser");
                return;
            }
        }
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.type = type;
        oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + duration);
    }
    
    function speak(text) {
        if (!soundEnabled || !('speechSynthesis' in window)) return;
        speechSynthesis.cancel(); // Cancel any previous speech
        const utterance = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(utterance);
    }

    function toggleSound() {
        soundEnabled = !soundEnabled;
        setCookie('soundEnabled', soundEnabled, 365);
        updateSoundToggleIcon();
        if(!soundEnabled) {
            speechSynthesis.cancel();
        }
    }

    function updateSoundToggleIcon() {
        soundToggle.innerHTML = soundEnabled 
            ? '<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>'
            : '<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg>';
    }

    // --- ANIMATIONS ---
    function triggerConfetti() {
        for (let i = 0; i < 100; i++) {
            createConfetti();
        }
    }

    function createConfetti() {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-10px';
        confetti.style.animationDuration = Math.random() * 2 + 3 + 's';
        confetti.style.transform = `translateX(${Math.random() * 200 - 100}px)`;
        document.body.appendChild(confetti);
        setTimeout(() => {
            confetti.remove();
        }, 5000);
    }
    
    // --- BRAIN BREAK CANVAS ANIMATIONS ---
    let bbCtx, bbWidth, bbHeight;
    
    function setupCanvas() {
        bbCtx = brainBreakCanvas.getContext('2d');
        bbWidth = brainBreakCanvas.width = brainBreakCanvas.offsetWidth;
        bbHeight = brainBreakCanvas.height = brainBreakCanvas.offsetHeight;
    }

    // 1. Bouncing Balls
    let balls = [];
    function initBouncingBalls() {
        setupCanvas();
        balls = [];
        for (let i = 0; i < 15; i++) {
            addBall();
        }
        brainBreakCanvas.onclick = (e) => {
            const rect = brainBreakCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            let ballClicked = false;
            for (let i = balls.length - 1; i >= 0; i--) {
                const dist = Math.hypot(mouseX - balls[i].x, mouseY - balls[i].y);
                if (dist < balls[i].radius) {
                    balls.splice(i, 1);
                    ballClicked = true;
                }
            }
            if (!ballClicked) {
                addBall(mouseX, mouseY);
            }
        };
        animateBouncingBalls();
    }
    function addBall(x = Math.random() * bbWidth, y = Math.random() * bbHeight) {
        balls.push({
            x: x, y: y,
            vx: Math.random() * 4 - 2,
            vy: Math.random() * 4 - 2,
            radius: Math.random() * 10 + 10,
            color: `hsl(${Math.random() * 360}, 70%, 60%)`
        });
    }
    function animateBouncingBalls() {
        bbCtx.clearRect(0, 0, bbWidth, bbHeight);
        balls.forEach(ball => {
            ball.x += ball.vx;
            ball.y += ball.vy;
            if (ball.x + ball.radius > bbWidth || ball.x - ball.radius < 0) ball.vx *= -1;
            if (ball.y + ball.radius > bbHeight || ball.y - ball.radius < 0) ball.vy *= -1;
            bbCtx.beginPath();
            bbCtx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            bbCtx.fillStyle = ball.color;
            bbCtx.fill();
        });
        currentBrainBreakAnimation = requestAnimationFrame(animateBouncingBalls);
    }
    
    // 2. 3D Starfield
    let stars = [], mouse = {x:0, y:0};
    function init3DStarfield() {
        setupCanvas();
        stars = [];
        mouse.x = bbWidth / 2;
        mouse.y = bbHeight / 2;
        for (let i=0; i < 500; i++) {
            stars.push({
                x: Math.random() * bbWidth * 2 - bbWidth,
                y: Math.random() * bbHeight * 2 - bbHeight,
                z: Math.random() * bbWidth
            });
        }
        brainBreakCanvas.onmousemove = (e) => {
            const rect = brainBreakCanvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        };
        animateStarfield();
    }
    function animateStarfield() {
        bbCtx.fillStyle = 'black';
        bbCtx.fillRect(0,0,bbWidth,bbHeight);
        let centerX = bbWidth / 2;
        let centerY = bbHeight / 2;
        let focalLength = bbWidth;
        let targetX = (mouse.x - centerX) * 0.1;
        let targetY = (mouse.y - centerY) * 0.1;

        bbCtx.save();
        bbCtx.translate(centerX, centerY);

        stars.forEach(star => {
            star.z -= 1.25; // Speed
            if (star.z <= 0) {
                 star.z = bbWidth;
            }
            let scale = focalLength / (focalLength + star.z);
            let r = star.z / 20;
            let px = (star.x - targetX) * scale;
            let py = (star.y - targetY) * scale;
            
            bbCtx.beginPath();
            bbCtx.arc(px, py, r * scale, 0, 2*Math.PI);
            bbCtx.fillStyle = 'white';
            bbCtx.fill();
        });
        bbCtx.restore();
        currentBrainBreakAnimation = requestAnimationFrame(animateStarfield);
    }

    // 3. Particle Trail
    let particles = [], hue = 0, ptMouse = {x:0, y:0, down:false};
    function initParticleTrail() {
        setupCanvas();
        particles = [];
        ptMouse.x = bbWidth/2;
        ptMouse.y = bbHeight/2;
        
        const moveHandler = (e) => {
             const rect = brainBreakCanvas.getBoundingClientRect();
             ptMouse.x = e.clientX - rect.left;
             ptMouse.y = e.clientY - rect.top;
        }
        brainBreakCanvas.onmousedown = () => ptMouse.down = true;
        brainBreakCanvas.onmouseup = () => ptMouse.down = false;
        brainBreakCanvas.onmousemove = moveHandler;
        
        animateParticleTrail();
    }

    class Particle {
        constructor() {
            this.x = ptMouse.x;
            this.y = ptMouse.y;
            this.size = Math.random() * 5 + 1;
            this.speedX = Math.random() * 3 - 1.5;
            this.speedY = Math.random() * 3 - 1.5;
            this.color = 'hsl(' + hue + ', 100%, 50%)';
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            if (this.size > 0.2) this.size -= 0.1;
        }
        draw() {
            bbCtx.fillStyle = this.color;
            bbCtx.beginPath();
            bbCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            bbCtx.fill();
        }
    }
    function handleParticles() {
        for(let i=0; i<5; i++) {
            particles.push(new Particle());
        }
        for (let i = 0; i < particles.length; i++) {
            particles[i].update();
            particles[i].draw();
            if (particles[i].size <= 0.3) {
                particles.splice(i, 1);
                i--;
            }
        }
    }
    function animateParticleTrail() {
        bbCtx.fillStyle = 'rgba(0,0,0,0.1)';
        bbCtx.fillRect(0, 0, bbWidth, bbHeight);
        handleParticles();
        hue+=2;
        currentBrainBreakAnimation = requestAnimationFrame(animateParticleTrail);
    }
    
</script>
</body>
</html>
